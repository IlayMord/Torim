{% extends "base.html" %}

{% block title %}TORIM - המלצות אישיות{% endblock %}

{% block content %}
<!-- Search Section -->
<div class="search-section">
    <div class="search-box">
        <i data-lucide="search" class="search-icon"></i>
        <input type="text" id="search-input" placeholder="חפש עסקים, שירותים..." onkeyup="handleSearchInput(this.value)">
    </div>
</div>

<!-- Categories -->
<div class="section">
    <h2 class="section-title">קטגוריות</h2>
    <div class="categories-grid">
        {% for category in categories %}
        <div class="category-card" onclick="location.href='/businesses?category={{ category.id }}'">
            <div class="category-icon">
                <i data-lucide="{{ category.icon }}"></i>
            </div>
            <div class="category-name">{{ category.name }}</div>
            <div class="category-count">{{ category.count }} עסקים</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Personalized Recommendations -->
<div class="section">
    <h2 class="section-title">מומלץ בשבילך</h2>
    <div class="recommendations-list">
        {% for rec in recommendations %}
        <div class="recommendation-card priority-{{ rec.priority }}" onclick="openBookingModalForBusiness({{ rec.business_id }})">
            <div class="recommendation-image">
                <img src="{{ rec.business_image }}" alt="{{ rec.business_name }}">
            </div>
            <div class="recommendation-content">
                <div class="recommendation-title">{{ rec.title }}</div>
                <div class="recommendation-description">{{ rec.description }}</div>
                <div class="recommendation-meta">
                    <div class="recommendation-business">{{ rec.business_name }}</div>
                    <div class="recommendation-reason">{{ rec.reason }}</div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function handleSearchInput(value) {
    if (value.length >= 2) {
        // Redirect to search page with query
        window.location.href = '/search?q=' + encodeURIComponent(value);
    }
}

function openBookingModalForBusiness(businessId) {
    // Fetch business data and open booking modal
    fetch(`/api/get-business/${businessId}`)
        .then(response => response.json())
        .then(business => {
            openBookingModal(business);
        })
        .catch(error => {
            console.error('Error fetching business:', error);
            showToast('שגיאה בטעינת נתוני העסק', 'error');
        });
}

function openBookingModal(business) {
    const modal = document.getElementById('booking-modal');
    const businessName = document.getElementById('booking-business-name');
    
    if (modal && businessName) {
        businessName.textContent = `הזמנת תור ב${business.name}`;
        modal.classList.add('active');
        
        // Store business data for booking
        window.currentBookingBusiness = business;
        
        // Load services
        loadBookingServices(business.services);
        showBookingStep(1);
    }
}

function loadBookingServices(services) {
    const container = document.getElementById('services-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    services.forEach(service => {
        const item = document.createElement('div');
        item.className = 'service-item';
        item.onclick = () => selectService(service, item);
        
        item.innerHTML = `
            <div class="service-info">
                <div class="service-name">${service.name}</div>
                <div class="service-duration">${service.duration} דקות</div>
            </div>
            <div class="service-price">₪${service.price}</div>
        `;
        
        container.appendChild(item);
    });
}

let bookingState = {
    selectedService: null,
    selectedDate: null,
    selectedTime: null,
    currentStep: 1
};

function selectService(service, element) {
    // Remove previous selection
    document.querySelectorAll('.service-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Add selection
    element.classList.add('selected');
    bookingState.selectedService = service;
}

function showBookingStep(step) {
    // Hide all steps
    document.querySelectorAll('.booking-step').forEach(s => {
        s.classList.add('hidden');
    });
    
    // Show current step
    document.getElementById(`step-${step}`).classList.remove('hidden');
    
    // Update buttons
    const prevBtn = document.getElementById('prev-step');
    const nextBtn = document.getElementById('next-step');
    const confirmBtn = document.getElementById('confirm-booking');
    
    if (step === 1) {
        prevBtn.classList.add('hidden');
        nextBtn.classList.remove('hidden');
        confirmBtn.classList.add('hidden');
    } else if (step === 2) {
        prevBtn.classList.remove('hidden');
        nextBtn.classList.remove('hidden');
        confirmBtn.classList.add('hidden');
    } else if (step === 3) {
        prevBtn.classList.remove('hidden');
        nextBtn.classList.add('hidden');
        confirmBtn.classList.remove('hidden');
        loadBookingSummary();
    }
    
    bookingState.currentStep = step;
}

function loadBookingSummary() {
    const container = document.getElementById('booking-summary');
    if (!container) return;
    
    const date = document.getElementById('booking-date').value;
    bookingState.selectedDate = date;
    
    const formattedDate = new Date(date).toLocaleDateString('he-IL', {
        weekday: 'long',
        day: 'numeric',
        month: 'long'
    });
    
    container.innerHTML = `
        <div class="summary-item">
            <span>עסק:</span>
            <span>${window.currentBookingBusiness.name}</span>
        </div>
        <div class="summary-item">
            <span>שירות:</span>
            <span>${bookingState.selectedService?.name || ''}</span>
        </div>
        <div class="summary-item">
            <span>תאריך:</span>
            <span>${formattedDate}</span>
        </div>
        <div class="summary-item">
            <span>שעה:</span>
            <span>${bookingState.selectedTime || ''}</span>
        </div>
        <div class="summary-item">
            <span>מחיר:</span>
            <span>₪${bookingState.selectedService?.price || 0}</span>
        </div>
    `;
}

// Event listeners for booking modal
document.addEventListener('DOMContentLoaded', function() {
    // Modal close
    const closeModal = document.getElementById('close-modal');
    if (closeModal) {
        closeModal.addEventListener('click', () => {
            document.getElementById('booking-modal').classList.remove('active');
        });
    }
    
    // Modal backdrop click
    const bookingModal = document.getElementById('booking-modal');
    if (bookingModal) {
        bookingModal.addEventListener('click', (e) => {
            if (e.target === bookingModal) {
                bookingModal.classList.remove('active');
            }
        });
    }
    
    // Next step
    const nextBtn = document.getElementById('next-step');
    if (nextBtn) {
        nextBtn.addEventListener('click', () => {
            if (bookingState.currentStep === 1) {
                if (!bookingState.selectedService) {
                    showToast('אנא בחר שירות', 'error');
                    return;
                }
                showBookingStep(2);
            } else if (bookingState.currentStep === 2) {
                const date = document.getElementById('booking-date').value;
                if (!date || !bookingState.selectedTime) {
                    showToast('אנא בחר תאריך ושעה', 'error');
                    return;
                }
                showBookingStep(3);
            }
        });
    }
    
    // Previous step
    const prevBtn = document.getElementById('prev-step');
    if (prevBtn) {
        prevBtn.addEventListener('click', () => {
            if (bookingState.currentStep > 1) {
                showBookingStep(bookingState.currentStep - 1);
            }
        });
    }
    
    // Confirm booking
    const confirmBtn = document.getElementById('confirm-booking');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', () => {
            confirmBooking();
        });
    }
    
    // Time slots
    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.addEventListener('click', () => {
            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
            slot.classList.add('selected');
            bookingState.selectedTime = slot.textContent;
        });
    });
});

function confirmBooking() {
    const bookingData = {
        business_id: window.currentBookingBusiness.id,
        service_id: bookingState.selectedService.id,
        date: bookingState.selectedDate,
        time: bookingState.selectedTime
    };
    
    fetch('/api/book-appointment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            document.getElementById('booking-modal').classList.remove('active');
            // Update appointments counter
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('שגיאה בהזמנת התור', 'error');
    });
}

function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}
</script>
{% endblock %}